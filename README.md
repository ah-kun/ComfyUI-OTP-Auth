# ComfyUI-User-Auth-OTP

[ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªç‰ˆã¸ã‚¸ãƒ£ãƒ³ãƒ—](#æ—¥æœ¬èª)

A custom node for ComfyUI that adds a simple One-Time Password (OTP) authentication using Google Authenticator or similar apps.
It acts as a "gatekeeper" to prevent unauthorized use when hosting ComfyUI on a publicly accessible server.

## Features

- **OTP Authentication**: Secure login using codes generated by Google Authenticator (TOTP).
- **First-Run Setup**: Displays a QR code on the first launch for easy pairing with your authenticator app.
- **Persistent Login**: Keeps you logged in for a set period (30 days) using cookies.
- **IP Whitelist**: Bypass authentication for specific IP addresses or CIDR ranges.
- **Localhost Exemption**: Option to skip authentication when accessing from `localhost`.

## Installation

1. Clone or download this repository into your ComfyUI `custom_nodes` folder.
2. Install the required dependencies:

```bash
pip install -r requirements.txt
```

## First-Time Setup

1. Start ComfyUI.
2. Open ComfyUI in your browser. You will see the **Initial Setup** screen.
3. Scan the displayed **QR Code** with your authenticator app (e.g., Google Authenticator).
   - *Note*: If you are using this locally, check "Allow Localhost without Auth" to skip authentication for local access in the future.
4. Enter the 6-digit code shown in your app and click "Complete Setup".
5. If the code is correct, setup is complete and you will be redirected to ComfyUI.

## Configuration (config.ini)

A `config.ini` file is automatically generated upon the first run. Edit this file to change settings.
Restart ComfyUI to apply changes.

```ini
[AUTH]
# Secret key for OTP (Base32). Automatically generated.
SECRET_KEY = XXXXXXXXXXXXXXXXXXXXXXX

# Cookie name for authentication. Automatically generated.
COOKIE_NAME = ComfyUI_Auth_abcdef12

# Setup completion flag. If True, skips the setup screen.
# Set to False to re-run the setup process.
IS_SETUP_COMPLETED = True

# Whether to skip authentication for localhost (127.0.0.1, ::1).
# True = Skip, False = Require Auth
SKIP_AUTH_ON_LOCALHOST = False

# List of IP addresses to skip authentication.
# Comma-separated list of IPs or CIDRs.
# Example: 192.168.1.5, 192.168.10.0/24
IP_WHITELIST = 
```

## How to Reset / Re-setup

If you want to reset your secret key or change authentication settings:

- **Method 1 (Full Reset)**: Delete `config.ini` and restart ComfyUI. A new secret key and QR code will be generated.
- **Method 2 (Keep Key)**: Edit `config.ini` and change `IS_SETUP_COMPLETED` to `False`, then restart. The setup screen will appear again using the *current* secret key.

---

<a name="æ—¥æœ¬èª"></a>
# ComfyUI-User-Auth-OTP (Japanese)

ComfyUIã«Google Authenticatorãªã©ã®OTPï¼ˆãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’ä½¿ç”¨ã—ãŸç°¡æ˜“çš„ãªèªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒ‰ã§ã™ã€‚
ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ãªã©ã§ã®ä¸æ­£åˆ©ç”¨ã‚’é˜²ããŸã‚ã®ã€Œé–€ç•ªã€ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

## æ©Ÿèƒ½

- **OTPèªè¨¼**: Google Authenticatorãªã©ã§ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³ã€‚
- **åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**: åˆå›èµ·å‹•æ™‚ã«QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã€ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã¨ã®é€£æºã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚
- **æ°¸ç¶šãƒ­ã‚°ã‚¤ãƒ³**: ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ä¸€å®šæœŸé–“ï¼ˆ30æ—¥ï¼‰ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒã—ã¾ã™ã€‚
- **IPãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ**: æŒ‡å®šã—ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„CIDRç¯„å›²ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªè¨¼ä¸è¦ã«ã§ãã¾ã™ã€‚
- **ãƒ­ãƒ¼ã‚«ãƒ«é™¤å¤–**: `localhost` ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªè¨¼ä¸è¦ã«ã™ã‚‹è¨­å®šãŒå¯èƒ½ã§ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

1. ComfyUIã® `custom_nodes` ãƒ•ã‚©ãƒ«ãƒ€ã«ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’é…ç½®ã—ã¾ã™ã€‚
2. ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
pip install -r requirements.txt
```

## åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. ComfyUIã‚’èµ·å‹•ã—ã¾ã™ã€‚
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ComfyUIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€**Initial Setup** ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
3. ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸ **QRã‚³ãƒ¼ãƒ‰** ã‚’Google Authenticatorãªã©ã®èªè¨¼ã‚¢ãƒ—ãƒªã§èª­ã¿å–ã‚Šã¾ã™ã€‚
   - â€» ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆè‡ªåˆ†ã®PCï¼‰ã ã‘ã§ä½¿ã†å ´åˆã¯ã€ã€ŒAllow Localhost without Authã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®èªè¨¼ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚
4. ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚ŒãŸ6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€ã€ŒComplete Setupã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
5. æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚Œã°èªè¨¼ãŒå®Œäº†ã—ã€ComfyUIã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

## è¨­å®š (config.ini)

åˆå›èµ·å‹•æ™‚ã« `config.ini` ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚å¾Œã‹ã‚‰è¨­å®šã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚
ComfyUIã‚’å†èµ·å‹•ã™ã‚‹ã¨å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚

```ini
[AUTH]
# OTPèªè¨¼ç”¨ã®ç§˜å¯†éµ (Base32)ã€‚è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
SECRET_KEY = XXXXXXXXXXXXXXXXXXXXXXX

# èªè¨¼ã‚¯ãƒƒã‚­ãƒ¼åã€‚è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
COOKIE_NAME = ComfyUI_Auth_abcdef12

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°ã€‚Trueã®å ´åˆã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
# å†ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸã„å ´åˆã¯ False ã«æˆ»ã—ã¦ãã ã•ã„ã€‚
IS_SETUP_COMPLETED = True

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆ (127.0.0.1, ::1) ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã§èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹ã©ã†ã‹ã€‚
# True = ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹, False = ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„
SKIP_AUTH_ON_LOCALHOST = False

# èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒªã‚¹ãƒˆã€‚
# ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°ã®IPã‚„CIDRã‚’æŒ‡å®šã§ãã¾ã™ã€‚
# ä¾‹: 192.168.1.5, 192.168.10.0/24
IP_WHITELIST = 
```

## å†ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•

ã‚‚ã—ç§˜å¯†éµã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸã„ã€ã¾ãŸã¯èªè¨¼è¨­å®šã‚’ã‚„ã‚Šç›´ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

- **æ–¹æ³•1 (ç°¡å˜)**: `config.ini` ã‚’å‰Šé™¤ã—ã¦ComfyUIã‚’å†èµ·å‹•ã™ã‚‹ã€‚ã™ã¹ã¦ãŒåˆæœŸåŒ–ã•ã‚Œã€æ–°ã—ã„QRã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
- **æ–¹æ³•2 (éµã‚’ç¶­æŒ)**: `config.ini` ã® `IS_SETUP_COMPLETED` ã‚’ `False` ã«æ›¸ãæ›ãˆã¦å†èµ·å‹•ã™ã‚‹ã€‚ç¾åœ¨ã®éµã®ã¾ã¾ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
